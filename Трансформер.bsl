// Общий модуль: Трансформер
// Сервер, Вызов сервера
//
// Универсальный конвертер форматов данных: JSON, TOON, CSV, XML
// TOON — Token-Oriented Object Notation для экономии токенов LLM
//
// Версия: 1.0.4
// Платформа: 8.3.10+
// Лицензия: MIT

#Область ПрограммныйИнтерфейс

Функция Прочитать(Знач Строка, Знач Формат = "JSON", Знач Параметры = Неопределено) Экспорт

    Формат = ВРег(Формат);

    Если Параметры = Неопределено Тогда
        Параметры = Новый Структура;
    КонецЕсли;

    Если Формат = "JSON" Тогда
        Возврат ПрочитатьФорматJSON(Строка, Параметры);
    ИначеЕсли Формат = "TOON" Тогда
        Возврат ПрочитатьФорматTOON(Строка, Параметры);
    ИначеЕсли Формат = "CSV" Тогда
        Возврат ПрочитатьФорматCSV(Строка, Параметры);
    ИначеЕсли Формат = "XML" Тогда
        Возврат ПрочитатьФорматXML(Строка, Параметры);
    Иначе
        ВызватьИсключение "Трансформер: Неизвестный формат """ + Формат + """";
    КонецЕсли;

КонецФункции

Функция Записать(Знач Данные, Знач Формат = "JSON", Знач Параметры = Неопределено) Экспорт

    Формат = ВРег(Формат);

    Если Параметры = Неопределено Тогда
        Параметры = Новый Структура;
    КонецЕсли;

    Если Формат = "JSON" Тогда
        Возврат ЗаписатьФорматJSON(Данные, Параметры);
    ИначеЕсли Формат = "TOON" Тогда
        Возврат ЗаписатьФорматTOON(Данные, Параметры);
    ИначеЕсли Формат = "CSV" Тогда
        Возврат ЗаписатьФорматCSV(Данные, Параметры);
    ИначеЕсли Формат = "XML" Тогда
        Возврат ЗаписатьФорматXML(Данные, Параметры);
    Иначе
        ВызватьИсключение "Трансформер: Неизвестный формат """ + Формат + """";
    КонецЕсли;

КонецФункции

Функция Конвертировать(Знач Строка, Знач ФорматИсточник, Знач ФорматПриёмник, 
    Знач ПараметрыЧтения = Неопределено, Знач ПараметрыЗаписи = Неопределено) Экспорт

    Данные = Прочитать(Строка, ФорматИсточник, ПараметрыЧтения);
    Возврат Записать(Данные, ФорматПриёмник, ПараметрыЗаписи);

КонецФункции

Функция ТаблицаВТООН(Знач Таблица, Знач ИмяМассива = "data", Знач Разделитель = ",") Экспорт

    Если Таблица.Количество() = 0 Тогда
        Возврат ИмяМассива + "[0]{}: ";
    КонецЕсли;

    Колонки = Новый Массив;
    Для Каждого Колонка Из Таблица.Колонки Цикл
        Колонки.Добавить(Колонка.Имя);
    КонецЦикла;

    Заголовок = ИмяМассива + "[" + Формат(Таблица.Количество(), "ЧГ=") + "]"
        + "{" + СтрСоединить(Колонки, Разделитель) + "}:";

    Строки = Новый Массив;
    Строки.Добавить(Заголовок);

    Для Каждого СтрокаТаблицы Из Таблица Цикл
        Значения = Новый Массив;
        Для Каждого ИмяКолонки Из Колонки Цикл
            Значения.Добавить(ЗначениеВСтрокуTOON(СтрокаТаблицы[ИмяКолонки], Разделитель));
        КонецЦикла;
        Строки.Добавить("  " + СтрСоединить(Значения, Разделитель));
    КонецЦикла;

    Возврат СтрСоединить(Строки, Символы.ПС);

КонецФункции

Функция ТООНВТаблицу(Знач СтрокаTOON, Знач Разделитель = ",") Экспорт

    Параметры = Новый Структура("Разделитель", Разделитель);
    Данные = ПрочитатьФорматTOON(СтрокаTOON, Параметры);

    Если ТипЗнч(Данные) = Тип("Массив") Тогда
        Возврат МассивВТаблицу(Данные);
    ИначеЕсли ТипЗнч(Данные) = Тип("Структура") ИЛИ ТипЗнч(Данные) = Тип("Соответствие") Тогда
        Для Каждого КлючЗначение Из Данные Цикл
            Если ТипЗнч(КлючЗначение.Значение) = Тип("Массив") Тогда
                Возврат МассивВТаблицу(КлючЗначение.Значение);
            КонецЕсли;
        КонецЦикла;
    КонецЕсли;

    Возврат Новый ТаблицаЗначений;

КонецФункции

Функция ТаблицаВCSV(Знач Таблица, Знач Разделитель = ";", Знач СЗаголовками = Истина) Экспорт
    Параметры = Новый Структура;
    Параметры.Вставить("Разделитель", Разделитель);
    Параметры.Вставить("СЗаголовками", СЗаголовками);
    Возврат ЗаписатьФорматCSV(Таблица, Параметры);
КонецФункции

Функция CSVВТаблицу(Знач СтрокаCSV, Знач Разделитель = ";", Знач ЕстьЗаголовки = Истина) Экспорт
    Параметры = Новый Структура;
    Параметры.Вставить("Разделитель", Разделитель);
    Параметры.Вставить("ЕстьЗаголовки", ЕстьЗаголовки);
    Массив = ПрочитатьФорматCSV(СтрокаCSV, Параметры);
    Возврат МассивВТаблицу(Массив);
КонецФункции

#КонецОбласти

#Область JSON

Функция ПрочитатьФорматJSON(Знач Строка, Знач Параметры)

    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(Строка);

    ПрочитатьВСоответствие = Ложь;
    Если Параметры.Свойство("ПрочитатьВСоответствие") Тогда
        ПрочитатьВСоответствие = Параметры.ПрочитатьВСоответствие;
    КонецЕсли;

    Возврат ПрочитатьJSON(ЧтениеJSON, ПрочитатьВСоответствие);

КонецФункции

// ИСПРАВЛЕНО v1.0.4: ПараметрыЗаписиJSON передаётся в УстановитьСтроку(), а НЕ в ЗаписатьJSON()
Функция ЗаписатьФорматJSON(Знач Данные, Знач Параметры)

    Если ТипЗнч(Данные) = Тип("ТаблицаЗначений") Тогда
        Данные = ТаблицаВМассив(Данные);
    КонецЕсли;

    ПереносСтрок = ПереносСтрокJSON.Нет;
    Если Параметры.Свойство("Форматировать") И Параметры.Форматировать Тогда
        ПереносСтрок = ПереносСтрокJSON.Авто;
    КонецЕсли;

    ПараметрыЗаписи = Новый ПараметрыЗаписиJSON(ПереносСтрок, "  ");

    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку(ПараметрыЗаписи);

    ЗаписатьJSON(ЗаписьJSON, Данные);

    Возврат ЗаписьJSON.Закрыть();

КонецФункции

#КонецОбласти

#Область XML

Функция ПрочитатьФорматXML(Знач Строка, Знач Параметры)

    ЧтениеXML = Новый ЧтениеXML;
    ЧтениеXML.УстановитьСтроку(Строка);

    КартаИмён = Новый Соответствие;

    Пока ЧтениеXML.Прочитать() Цикл
        Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
            Прервать;
        КонецЕсли;
    КонецЦикла;

    Результат = ПрочитатьЭлементXML(ЧтениеXML, КартаИмён);
    ЧтениеXML.Закрыть();

    Возврат Результат;

КонецФункции

Функция ПрочитатьЭлементXML(ЧтениеXML, КартаИмён)

    Результат = Новый Структура;
    ДочерниеЭлементы = Новый Соответствие;
    ТекстовоеСодержимое = "";
    ЕстьАтрибуты = Ложь;

    Если ЧтениеXML.КоличествоАтрибутов() > 0 Тогда
        ЕстьАтрибуты = Истина;
        Для Инд = 0 По ЧтениеXML.КоличествоАтрибутов() - 1 Цикл
            ИмяОригинал = ЧтениеXML.ИмяАтрибута(Инд);
            ИмяКлюча = "attr_" + ЭкранироватьИмяКлюча(ИмяОригинал);
            КартаИмён.Вставить(ИмяКлюча, "@" + ИмяОригинал);
            Результат.Вставить(ИмяКлюча, XMLЗначениеВТип(ЧтениеXML.ЗначениеАтрибута(Инд)));
        КонецЦикла;
    КонецЕсли;

    Пока ЧтениеXML.Прочитать() Цикл

        Если ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента Тогда
            Прервать;

        ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
            ИмяОригинал = ЧтениеXML.Имя;
            ИмяКлюча = ЭкранироватьИмяКлюча(ИмяОригинал);
            КартаИмён.Вставить(ИмяКлюча, ИмяОригинал);
            ЗначениеДочернего = ПрочитатьЭлементXML(ЧтениеXML, КартаИмён);

            Если ДочерниеЭлементы[ИмяКлюча] = Неопределено Тогда
                ДочерниеЭлементы[ИмяКлюча] = Новый Массив;
            КонецЕсли;
            ДочерниеЭлементы[ИмяКлюча].Добавить(ЗначениеДочернего);

        ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.Текст 
            ИЛИ ЧтениеXML.ТипУзла = ТипУзлаXML.ПробельныеСимволы Тогда
            ТекстовоеСодержимое = ТекстовоеСодержимое + ЧтениеXML.Значение;

        ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.СекцияCDATA Тогда
            ТекстовоеСодержимое = ТекстовоеСодержимое + ЧтениеXML.Значение;

        КонецЕсли;

    КонецЦикла;

    Если ДочерниеЭлементы.Количество() = 0 И НЕ ЕстьАтрибуты Тогда
        Возврат XMLЗначениеВТип(СокрЛП(ТекстовоеСодержимое));
    КонецЕсли;

    Для Каждого КлючЗначение Из ДочерниеЭлементы Цикл
        Если КлючЗначение.Значение.Количество() = 1 Тогда
            Результат.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение[0]);
        Иначе
            Результат.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
        КонецЕсли;
    КонецЦикла;

    ТекстОчищенный = СокрЛП(ТекстовоеСодержимое);
    Если НЕ ПустаяСтрока(ТекстОчищенный) И (ДочерниеЭлементы.Количество() > 0 ИЛИ ЕстьАтрибуты) Тогда
        Результат.Вставить("text_", XMLЗначениеВТип(ТекстОчищенный));
    КонецЕсли;

    Возврат Результат;

КонецФункции

Функция XMLЗначениеВТип(Знач Значение)

    Если Значение = Неопределено Тогда
        Возврат Null;
    КонецЕсли;

    Значение = СокрЛП(Значение);

    Если ПустаяСтрока(Значение) Тогда
        Возврат "";
    КонецЕсли;

    ЗначениеНР = НРег(Значение);

    Если ЗначениеНР = "true" ИЛИ ЗначениеНР = "yes" Тогда
        Возврат Истина;
    КонецЕсли;
    Если ЗначениеНР = "false" ИЛИ ЗначениеНР = "no" Тогда
        Возврат Ложь;
    КонецЕсли;
    Если ЗначениеНР = "null" ИЛИ ЗначениеНР = "nil" Тогда
        Возврат Null;
    КонецЕсли;

    Если СтрокаЯвляетсяЧислом(Значение) Тогда
        Возврат Число(СтрЗаменить(Значение, " ", ""));
    КонецЕсли;

    Если СтрДлина(Значение) >= 10 И Сред(Значение, 5, 1) = "-" И Сред(Значение, 8, 1) = "-" Тогда
        Попытка
            Если СтрДлина(Значение) = 10 Тогда
                Возврат Дата(СтрЗаменить(Значение, "-", "") + "000000");
            ИначеЕсли СтрДлина(Значение) >= 19 Тогда
                ДатаСтр = Лев(Значение, 10);
                ВремяСтр = Сред(Значение, 12, 8);
                Возврат Дата(СтрЗаменить(ДатаСтр, "-", "") + СтрЗаменить(ВремяСтр, ":", ""));
            КонецЕсли;
        Исключение
        КонецПопытки;
    КонецЕсли;

    Возврат Значение;

КонецФункции

Функция ЗаписатьФорматXML(Знач Данные, Знач Параметры)

    Если ТипЗнч(Данные) = Тип("ТаблицаЗначений") Тогда
        Данные = ТаблицаВМассив(Данные);
    КонецЕсли;

    КорневойЭлемент = "root";
    Если Параметры.Свойство("КорневойЭлемент") Тогда
        КорневойЭлемент = Параметры.КорневойЭлемент;
    КонецЕсли;

    ЭлементМассива = "item";
    Если Параметры.Свойство("ЭлементМассива") Тогда
        ЭлементМассива = Параметры.ЭлементМассива;
    КонецЕсли;

    Форматировать = Ложь;
    Если Параметры.Свойство("Форматировать") Тогда
        Форматировать = Параметры.Форматировать;
    КонецЕсли;

    Контекст = Новый Структура;
    Контекст.Вставить("ЭлементМассива", ЭлементМассива);
    Контекст.Вставить("Форматировать", Форматировать);
    Контекст.Вставить("Строки", Новый Массив);

    Контекст.Строки.Добавить("<?xml version=""1.0"" encoding=""UTF-8""?>");
    ЗаписатьЭлементXML(Данные, КорневойЭлемент, 0, Контекст);

    Возврат СтрСоединить(Контекст.Строки, ?(Форматировать, Символы.ПС, ""));

КонецФункции

Процедура ЗаписатьЭлементXML(Знач Значение, Знач ИмяЭлемента, Знач Уровень, Контекст)

    Отступ = ?(Контекст.Форматировать, ПолучитьОтступ(Уровень), "");
    ТипЗначения = ТипЗнч(Значение);

    Если Значение = Неопределено ИЛИ Значение = Null Тогда
        Контекст.Строки.Добавить(Отступ + "<" + ИмяЭлемента + "/>");

    ИначеЕсли ТипЗначения = Тип("Структура") ИЛИ ТипЗначения = Тип("Соответствие") Тогда
        Атрибуты = "";
        ДочерниеЭлементы = Новый Массив;
        ТекстовоеСодержимое = "";

        Для Каждого КлючЗначение Из Значение Цикл
            Если Лев(КлючЗначение.Ключ, 5) = "attr_" Тогда
                ИмяАтрибута = Сред(КлючЗначение.Ключ, 6);
                Атрибуты = Атрибуты + " " + ИмяАтрибута + "=""" + ЗначениеВСтрокуXML(КлючЗначение.Значение) + """";
            ИначеЕсли КлючЗначение.Ключ = "text_" Тогда
                ТекстовоеСодержимое = ЗначениеВСтрокуXML(КлючЗначение.Значение);
            Иначе
                ДочерниеЭлементы.Добавить(КлючЗначение);
            КонецЕсли;
        КонецЦикла;

        Если ДочерниеЭлементы.Количество() = 0 И ПустаяСтрока(ТекстовоеСодержимое) Тогда
            Контекст.Строки.Добавить(Отступ + "<" + ИмяЭлемента + Атрибуты + "/>");
        ИначеЕсли ДочерниеЭлементы.Количество() = 0 Тогда
            Контекст.Строки.Добавить(Отступ + "<" + ИмяЭлемента + Атрибуты + ">" + ТекстовоеСодержимое + "</" + ИмяЭлемента + ">");
        Иначе
            Контекст.Строки.Добавить(Отступ + "<" + ИмяЭлемента + Атрибуты + ">");

            Если НЕ ПустаяСтрока(ТекстовоеСодержимое) Тогда
                Контекст.Строки.Добавить(?(Контекст.Форматировать, ПолучитьОтступ(Уровень + 1), "") + ТекстовоеСодержимое);
            КонецЕсли;

            Для Каждого КлючЗначение Из ДочерниеЭлементы Цикл
                Если ТипЗнч(КлючЗначение.Значение) = Тип("Массив") Тогда
                    Для Каждого ЭлементМассива Из КлючЗначение.Значение Цикл
                        ЗаписатьЭлементXML(ЭлементМассива, КлючЗначение.Ключ, Уровень + 1, Контекст);
                    КонецЦикла;
                Иначе
                    ЗаписатьЭлементXML(КлючЗначение.Значение, КлючЗначение.Ключ, Уровень + 1, Контекст);
                КонецЕсли;
            КонецЦикла;

            Контекст.Строки.Добавить(Отступ + "</" + ИмяЭлемента + ">");
        КонецЕсли;

    ИначеЕсли ТипЗначения = Тип("Массив") Тогда
        Контекст.Строки.Добавить(Отступ + "<" + ИмяЭлемента + ">");
        Для Каждого Элемент Из Значение Цикл
            ЗаписатьЭлементXML(Элемент, Контекст.ЭлементМассива, Уровень + 1, Контекст);
        КонецЦикла;
        Контекст.Строки.Добавить(Отступ + "</" + ИмяЭлемента + ">");

    Иначе
        СтрЗначение = ЗначениеВСтрокуXML(Значение);
        Контекст.Строки.Добавить(Отступ + "<" + ИмяЭлемента + ">" + СтрЗначение + "</" + ИмяЭлемента + ">");
    КонецЕсли;

КонецПроцедуры

Функция ЗначениеВСтрокуXML(Знач Значение)

    Если Значение = Неопределено ИЛИ Значение = Null Тогда
        Возврат "";
    КонецЕсли;

    Если ТипЗнч(Значение) = Тип("Булево") Тогда
        Возврат ?(Значение, "true", "false");
    КонецЕсли;

    Если ТипЗнч(Значение) = Тип("Дата") Тогда
        Если Значение = '00010101' Тогда
            Возврат "";
        КонецЕсли;
        Возврат Формат(Значение, "ДФ=yyyy-MM-ddTHH:mm:ss");
    КонецЕсли;

    Если ТипЗнч(Значение) = Тип("Число") Тогда
        Возврат Формат(Значение, "ЧРД=.; ЧГ=");
    КонецЕсли;

    СтрЗначение = Строка(Значение);
    СтрЗначение = СтрЗаменить(СтрЗначение, "&", "&amp;");
    СтрЗначение = СтрЗаменить(СтрЗначение, "<", "&lt;");
    СтрЗначение = СтрЗаменить(СтрЗначение, ">", "&gt;");
    СтрЗначение = СтрЗаменить(СтрЗначение, """", "&quot;");
    СтрЗначение = СтрЗаменить(СтрЗначение, "'", "&apos;");

    Возврат СтрЗначение;

КонецФункции

#КонецОбласти

#Область TOON

Функция ЗаписатьФорматTOON(Знач Данные, Знач Параметры)

    Если ТипЗнч(Данные) = Тип("ТаблицаЗначений") Тогда
        Данные = ТаблицаВМассив(Данные);
    КонецЕсли;

    Разделитель = ",";
    Если Параметры.Свойство("Разделитель") Тогда
        Разделитель = Параметры.Разделитель;
    КонецЕсли;

    Контекст = Новый Структура;
    Контекст.Вставить("Разделитель", Разделитель);
    Контекст.Вставить("Строки", Новый Массив);

    СериализоватьЗначениеTOON(Данные, "", 0, Контекст);

    Возврат СтрСоединить(Контекст.Строки, Символы.ПС);

КонецФункции

Процедура СериализоватьЗначениеTOON(Знач Значение, Знач Ключ, Знач Уровень, Контекст)

    Отступ = ПолучитьОтступ(Уровень);
    ТипЗначения = ТипЗнч(Значение);

    Если ТипЗначения = Тип("Структура") ИЛИ ТипЗначения = Тип("Соответствие") Тогда
        СериализоватьОбъектTOON(Значение, Ключ, Уровень, Контекст);
    ИначеЕсли ТипЗначения = Тип("Массив") Тогда
        СериализоватьМассивTOON(Значение, Ключ, Уровень, Контекст);
    ИначеЕсли ТипЗначения = Тип("ТаблицаЗначений") Тогда
        СериализоватьМассивTOON(ТаблицаВМассив(Значение), Ключ, Уровень, Контекст);
    Иначе
        СтрЗначение = ЗначениеВСтрокуTOON(Значение, Контекст.Разделитель);
        Если ПустаяСтрока(Ключ) Тогда
            Контекст.Строки.Добавить(Отступ + СтрЗначение);
        Иначе
            Контекст.Строки.Добавить(Отступ + Ключ + ": " + СтрЗначение);
        КонецЕсли;
    КонецЕсли;

КонецПроцедуры

Процедура СериализоватьОбъектTOON(Знач Объект, Знач Ключ, Знач Уровень, Контекст)

    Отступ = ПолучитьОтступ(Уровень);

    Если НЕ ПустаяСтрока(Ключ) Тогда
        Контекст.Строки.Добавить(Отступ + Ключ + ":");
        Уровень = Уровень + 1;
    КонецЕсли;

    Для Каждого КлючЗначение Из Объект Цикл
        СериализоватьЗначениеTOON(КлючЗначение.Значение, КлючЗначение.Ключ, Уровень, Контекст);
    КонецЦикла;

КонецПроцедуры

Процедура СериализоватьМассивTOON(Знач Массив, Знач Ключ, Знач Уровень, Контекст)

    Отступ = ПолучитьОтступ(Уровень);
    Количество = Массив.Количество();
    Разделитель = Контекст.Разделитель;

    Если Количество = 0 Тогда
        Контекст.Строки.Добавить(Отступ + Ключ + "[0]: ");
        Возврат;
    КонецЕсли;

    ПервыйЭлемент = Массив[0];
    ТипПервого = ТипЗнч(ПервыйЭлемент);

    Если ТипПервого = Тип("Структура") ИЛИ ТипПервого = Тип("Соответствие") Тогда
        Если МассивОднороден(Массив) Тогда
            СериализоватьТабличныйМассивTOON(Массив, Ключ, Уровень, Контекст);
        Иначе
            СериализоватьНеоднородныйМассивTOON(Массив, Ключ, Уровень, Контекст);
        КонецЕсли;
    ИначеЕсли ТипПервого = Тип("Массив") Тогда
        СериализоватьНеоднородныйМассивTOON(Массив, Ключ, Уровень, Контекст);
    Иначе
        Значения = Новый Массив;
        Для Каждого Элемент Из Массив Цикл
            Значения.Добавить(ЗначениеВСтрокуTOON(Элемент, Разделитель));
        КонецЦикла;
        Контекст.Строки.Добавить(Отступ + Ключ + "[" + Формат(Количество, "ЧГ=") + "]: " + СтрСоединить(Значения, Разделитель));
    КонецЕсли;

КонецПроцедуры

Процедура СериализоватьТабличныйМассивTOON(Знач Массив, Знач Ключ, Знач Уровень, Контекст)

    Отступ = ПолучитьОтступ(Уровень);
    ОтступСтроки = ПолучитьОтступ(Уровень + 1);
    Количество = Массив.Количество();
    Разделитель = Контекст.Разделитель;

    ПервыйЭлемент = Массив[0];
    Поля = Новый Массив;
    Для Каждого КлючЗначение Из ПервыйЭлемент Цикл
        Поля.Добавить(КлючЗначение.Ключ);
    КонецЦикла;

    Заголовок = Ключ + "[" + Формат(Количество, "ЧГ=") + "]{" + СтрСоединить(Поля, Разделитель) + "}:";
    Контекст.Строки.Добавить(Отступ + Заголовок);

    Для Каждого Элемент Из Массив Цикл
        Значения = Новый Массив;
        Для Каждого ИмяПоля Из Поля Цикл
            Если ТипЗнч(Элемент) = Тип("Структура") Тогда
                Если Элемент.Свойство(ИмяПоля) Тогда
                    Значения.Добавить(ЗначениеВСтрокуTOON(Элемент[ИмяПоля], Разделитель));
                Иначе
                    Значения.Добавить("");
                КонецЕсли;
            Иначе
                Если Элемент[ИмяПоля] <> Неопределено Тогда
                    Значения.Добавить(ЗначениеВСтрокуTOON(Элемент[ИмяПоля], Разделитель));
                Иначе
                    Значения.Добавить("");
                КонецЕсли;
            КонецЕсли;
        КонецЦикла;
        Контекст.Строки.Добавить(ОтступСтроки + СтрСоединить(Значения, Разделитель));
    КонецЦикла;

КонецПроцедуры

Процедура СериализоватьНеоднородныйМассивTOON(Знач Массив, Знач Ключ, Знач Уровень, Контекст)

    Отступ = ПолучитьОтступ(Уровень);
    Количество = Массив.Количество();

    Контекст.Строки.Добавить(Отступ + Ключ + "[" + Формат(Количество, "ЧГ=") + "]:");

    Для Каждого Элемент Из Массив Цикл
        ТипЭлемента = ТипЗнч(Элемент);

        Если ТипЭлемента = Тип("Структура") ИЛИ ТипЭлемента = Тип("Соответствие") Тогда
            Контекст.Строки.Добавить(ПолучитьОтступ(Уровень + 1) + "-");
            Для Каждого КлючЗначение Из Элемент Цикл
                СериализоватьЗначениеTOON(КлючЗначение.Значение, КлючЗначение.Ключ, Уровень + 2, Контекст);
            КонецЦикла;
        Иначе
            Контекст.Строки.Добавить(ПолучитьОтступ(Уровень + 1) + "- " + ЗначениеВСтрокуTOON(Элемент, Контекст.Разделитель));
        КонецЕсли;
    КонецЦикла;

КонецПроцедуры

Функция ПрочитатьФорматTOON(Знач Строка, Знач Параметры = Неопределено)

    Если Параметры = Неопределено Тогда
        Параметры = Новый Структура;
    КонецЕсли;

    Разделитель = ",";
    Если Параметры.Свойство("Разделитель") Тогда
        Разделитель = Параметры.Разделитель;
    КонецЕсли;

    СтрокиИсходные = СтрРазделить(Строка, Символы.ПС, Ложь);

    Строки = Новый Массив;
    Для Каждого Стр Из СтрокиИсходные Цикл
        СтрОчищенная = СокрЛП(Стр);
        Если НЕ ПустаяСтрока(СтрОчищенная) И Лев(СтрОчищенная, 1) <> "#" Тогда
            Строки.Добавить(Стр);
        КонецЕсли;
    КонецЦикла;

    Если Строки.Количество() = 0 Тогда
        Возврат Новый Структура;
    КонецЕсли;

    Контекст = Новый Структура;
    Контекст.Вставить("Строки", Строки);
    Контекст.Вставить("Индекс", 0);
    Контекст.Вставить("Разделитель", Разделитель);

    Возврат ПарсерTOON_ПрочитатьОбъект(Контекст, 0);

КонецФункции

Функция ПарсерTOON_ПрочитатьОбъект(Контекст, ОжидаемыйУровень)

    Результат = Новый Структура;

    Пока Контекст.Индекс < Контекст.Строки.Количество() Цикл

        ТекущаяСтрока = Контекст.Строки[Контекст.Индекс];
        Уровень = ПолучитьУровеньОтступа(ТекущаяСтрока);

        Если Уровень < ОжидаемыйУровень Тогда
            Прервать;
        КонецЕсли;

        Если Уровень > ОжидаемыйУровень Тогда
            Контекст.Индекс = Контекст.Индекс + 1;
            Продолжить;
        КонецЕсли;

        СтрокаБезОтступа = СокрЛ(ТекущаяСтрока);
        Контекст.Индекс = Контекст.Индекс + 1;

        РезультатПарсинга = ПарсерTOON_РазобратьСтроку(СтрокаБезОтступа, Контекст);

        Если РезультатПарсинга.Тип = "КлючЗначение" Тогда
            Результат.Вставить(РезультатПарсинга.Ключ, РезультатПарсинга.Значение);
        ИначеЕсли РезультатПарсинга.Тип = "КлючОбъект" Тогда
            ВложенныйОбъект = ПарсерTOON_ПрочитатьОбъект(Контекст, Уровень + 1);
            Результат.Вставить(РезультатПарсинга.Ключ, ВложенныйОбъект);
        ИначеЕсли РезультатПарсинга.Тип = "МассивПростой" Тогда
            Результат.Вставить(РезультатПарсинга.Ключ, РезультатПарсинга.Значение);
        ИначеЕсли РезультатПарсинга.Тип = "МассивТабличный" Тогда
            Массив = ПарсерTOON_ПрочитатьТабличныйМассив(Контекст, Уровень + 1, РезультатПарсинга.Поля, РезультатПарсинга.Количество);
            Результат.Вставить(РезультатПарсинга.Ключ, Массив);
        ИначеЕсли РезультатПарсинга.Тип = "МассивНеоднородный" Тогда
            Массив = ПарсерTOON_ПрочитатьНеоднородныйМассив(Контекст, Уровень + 1);
            Результат.Вставить(РезультатПарсинга.Ключ, Массив);
        КонецЕсли;

    КонецЦикла;

    Возврат Результат;

КонецФункции

Функция ПарсерTOON_РазобратьСтроку(Знач Строка, Контекст)

    Результат = Новый Структура("Тип,Ключ,Значение,Поля,Количество");
    Разделитель = Контекст.Разделитель;

    ПозДвоеточия = СтрНайти(Строка, ":");

    Если ПозДвоеточия = 0 Тогда
        Результат.Тип = "Значение";
        Результат.Значение = СтрокаВЗначениеTOON(Строка);
        Возврат Результат;
    КонецЕсли;

    ЛеваяЧасть = Лев(Строка, ПозДвоеточия - 1);
    ПраваяЧасть = СокрЛ(Сред(Строка, ПозДвоеточия + 1));

    ПозСкобки = СтрНайти(ЛеваяЧасть, "[");

    Если ПозСкобки > 0 Тогда
        Результат.Ключ = Лев(ЛеваяЧасть, ПозСкобки - 1);

        ПозЗакрСкобки = СтрНайти(ЛеваяЧасть, "]");
        Результат.Количество = Число(Сред(ЛеваяЧасть, ПозСкобки + 1, ПозЗакрСкобки - ПозСкобки - 1));

        ПозФигСкобки = СтрНайти(ЛеваяЧасть, "{");

        Если ПозФигСкобки > 0 Тогда
            ПозЗакрФигСкобки = СтрНайти(ЛеваяЧасть, "}");
            СтрПоля = Сред(ЛеваяЧасть, ПозФигСкобки + 1, ПозЗакрФигСкобки - ПозФигСкобки - 1);
            Результат.Поля = СтрРазделить(СтрПоля, Разделитель);
            Результат.Тип = "МассивТабличный";
        ИначеЕсли ПустаяСтрока(ПраваяЧасть) Тогда
            Результат.Тип = "МассивНеоднородный";
        Иначе
            Значения = ПарсерTOON_РазобратьCSVСтроку(ПраваяЧасть, Разделитель);
            Массив = Новый Массив;
            Для Каждого СтрЗначение Из Значения Цикл
                Массив.Добавить(СтрокаВЗначениеTOON(СтрЗначение));
            КонецЦикла;
            Результат.Значение = Массив;
            Результат.Тип = "МассивПростой";
        КонецЕсли;
    Иначе
        Результат.Ключ = СокрЛП(ЛеваяЧасть);
        Если ПустаяСтрока(ПраваяЧасть) Тогда
            Результат.Тип = "КлючОбъект";
        Иначе
            Результат.Значение = СтрокаВЗначениеTOON(ПраваяЧасть);
            Результат.Тип = "КлючЗначение";
        КонецЕсли;
    КонецЕсли;

    Возврат Результат;

КонецФункции

Функция ПарсерTOON_ПрочитатьТабличныйМассив(Контекст, ОжидаемыйУровень, Поля, Количество)

    Массив = Новый Массив;
    Разделитель = Контекст.Разделитель;

    Пока Контекст.Индекс < Контекст.Строки.Количество() И Массив.Количество() < Количество Цикл

        ТекущаяСтрока = Контекст.Строки[Контекст.Индекс];
        Уровень = ПолучитьУровеньОтступа(ТекущаяСтрока);

        Если Уровень < ОжидаемыйУровень Тогда
            Прервать;
        КонецЕсли;

        Контекст.Индекс = Контекст.Индекс + 1;
        СтрокаБезОтступа = СокрЛП(ТекущаяСтрока);

        Значения = ПарсерTOON_РазобратьCSVСтроку(СтрокаБезОтступа, Разделитель);

        Объект = Новый Структура;
        Для Инд = 0 По МинЗнач(Поля.Количество(), Значения.Количество()) - 1 Цикл
            Объект.Вставить(СокрЛП(Поля[Инд]), СтрокаВЗначениеTOON(Значения[Инд]));
        КонецЦикла;

        Массив.Добавить(Объект);

    КонецЦикла;

    Возврат Массив;

КонецФункции

Функция ПарсерTOON_ПрочитатьНеоднородныйМассив(Контекст, ОжидаемыйУровень)

    Массив = Новый Массив;

    Пока Контекст.Индекс < Контекст.Строки.Количество() Цикл

        ТекущаяСтрока = Контекст.Строки[Контекст.Индекс];
        Уровень = ПолучитьУровеньОтступа(ТекущаяСтрока);

        Если Уровень < ОжидаемыйУровень Тогда
            Прервать;
        КонецЕсли;

        СтрокаБезОтступа = СокрЛП(ТекущаяСтрока);

        Если Лев(СтрокаБезОтступа, 1) = "-" Тогда
            Контекст.Индекс = Контекст.Индекс + 1;
            ПослеДефиса = СокрЛ(Сред(СтрокаБезОтступа, 2));

            Если ПустаяСтрока(ПослеДефиса) Тогда
                Массив.Добавить(ПарсерTOON_ПрочитатьОбъект(Контекст, Уровень + 1));
            Иначе
                Массив.Добавить(СтрокаВЗначениеTOON(ПослеДефиса));
            КонецЕсли;
        Иначе
            Прервать;
        КонецЕсли;

    КонецЦикла;

    Возврат Массив;

КонецФункции

Функция ПарсерTOON_РазобратьCSVСтроку(Знач Строка, Знач Разделитель)

    Результат = Новый Массив;
    ТекущееЗначение = "";
    ВнутриКавычек = Ложь;
    СимволКавычки = """";

    Для Поз = 1 По СтрДлина(Строка) Цикл
        Символ = Сред(Строка, Поз, 1);

        Если Символ = СимволКавычки Тогда
            Если ВнутриКавычек Тогда
                Если Поз < СтрДлина(Строка) И Сред(Строка, Поз + 1, 1) = СимволКавычки Тогда
                    ТекущееЗначение = ТекущееЗначение + СимволКавычки;
                    Поз = Поз + 1;
                Иначе
                    ВнутриКавычек = Ложь;
                КонецЕсли;
            Иначе
                ВнутриКавычек = Истина;
            КонецЕсли;
        ИначеЕсли Символ = Разделитель И НЕ ВнутриКавычек Тогда
            Результат.Добавить(СокрЛП(ТекущееЗначение));
            ТекущееЗначение = "";
        Иначе
            ТекущееЗначение = ТекущееЗначение + Символ;
        КонецЕсли;
    КонецЦикла;

    Результат.Добавить(СокрЛП(ТекущееЗначение));
    Возврат Результат;

КонецФункции

#КонецОбласти

#Область CSV

Функция ПрочитатьФорматCSV(Знач Строка, Знач Параметры)

    Разделитель = ";";
    Если Параметры.Свойство("Разделитель") Тогда
        Разделитель = Параметры.Разделитель;
    КонецЕсли;

    ЕстьЗаголовки = Истина;
    Если Параметры.Свойство("ЕстьЗаголовки") Тогда
        ЕстьЗаголовки = Параметры.ЕстьЗаголовки;
    КонецЕсли;

    СтрокиИсходные = СтрРазделить(Строка, Символы.ПС, Ложь);

    Если СтрокиИсходные.Количество() = 0 Тогда
        Возврат Новый Массив;
    КонецЕсли;

    Результат = Новый Массив;
    Заголовки = Неопределено;

    Для Инд = 0 По СтрокиИсходные.Количество() - 1 Цикл

        СтрокаCSV = СтрокиИсходные[Инд];
        Если ПустаяСтрока(СокрЛП(СтрокаCSV)) Тогда
            Продолжить;
        КонецЕсли;

        Значения = ПарсерTOON_РазобратьCSVСтроку(СтрокаCSV, Разделитель);

        Если Инд = 0 И ЕстьЗаголовки Тогда
            Заголовки = Значения;
            Продолжить;
        КонецЕсли;

        Если Заголовки <> Неопределено Тогда
            Объект = Новый Структура;
            Для ИндКол = 0 По МинЗнач(Заголовки.Количество(), Значения.Количество()) - 1 Цикл
                ИмяКолонки = СокрЛП(Заголовки[ИндКол]);
                Если НЕ ПустаяСтрока(ИмяКолонки) Тогда
                    Объект.Вставить(ИмяКолонки, Значения[ИндКол]);
                КонецЕсли;
            КонецЦикла;
            Результат.Добавить(Объект);
        Иначе
            Результат.Добавить(Значения);
        КонецЕсли;

    КонецЦикла;

    Возврат Результат;

КонецФункции

Функция ЗаписатьФорматCSV(Знач Данные, Знач Параметры)

    Разделитель = ";";
    Если Параметры.Свойство("Разделитель") Тогда
        Разделитель = Параметры.Разделитель;
    КонецЕсли;

    СЗаголовками = Истина;
    Если Параметры.Свойство("СЗаголовками") Тогда
        СЗаголовками = Параметры.СЗаголовками;
    КонецЕсли;

    Если ТипЗнч(Данные) = Тип("ТаблицаЗначений") Тогда
        Данные = ТаблицаВМассив(Данные);
    КонецЕсли;

    // ====== ИСПРАВЛЕНИЕ 1: Структура/Соответствие → извлечь массив или обернуть ======
    Если ТипЗнч(Данные) = Тип("Структура") ИЛИ ТипЗнч(Данные) = Тип("Соответствие") Тогда
        МассивНайден = Ложь;
        Для Каждого КлючЗначение Из Данные Цикл
            Если ТипЗнч(КлючЗначение.Значение) = Тип("Массив") Тогда
                Данные = КлючЗначение.Значение;
                МассивНайден = Истина;
                Прервать;
            КонецЕсли;
        КонецЦикла;
        Если НЕ МассивНайден Тогда
            Обёртка = Новый Массив;
            Обёртка.Добавить(Данные);
            Данные = Обёртка;
        КонецЕсли;
    КонецЕсли;

    // ====== ИСПРАВЛЕНИЕ 2: сплющить вложенные структуры в элементах массива ======
    Если ТипЗнч(Данные) = Тип("Массив") И Данные.Количество() > 0 Тогда
        ПервыйЭлемент = Данные[0];
        Если ТипЗнч(ПервыйЭлемент) = Тип("Структура") 
            ИЛИ ТипЗнч(ПервыйЭлемент) = Тип("Соответствие") Тогда
            ЕстьВложенные = Ложь;
            Для Каждого КлючЗначение Из ПервыйЭлемент Цикл
                ТипЗначения = ТипЗнч(КлючЗначение.Значение);
                Если ТипЗначения = Тип("Структура") 
                    ИЛИ ТипЗначения = Тип("Соответствие") 
                    ИЛИ ТипЗначения = Тип("Массив") Тогда
                    ЕстьВложенные = Истина;
                    Прервать;
                КонецЕсли;
            КонецЦикла;
            Если ЕстьВложенные Тогда
                НовыйМассив = Новый Массив;
                Для Каждого Элемент Из Данные Цикл
                    НовыйМассив.Добавить(СплющитьСтруктуруCSV(Элемент, ""));
                КонецЦикла;
                Данные = НовыйМассив;
            КонецЕсли;
        КонецЕсли;
    КонецЕсли;
    // ====== КОНЕЦ ИСПРАВЛЕНИЙ ======

    Если ТипЗнч(Данные) <> Тип("Массив") ИЛИ Данные.Количество() = 0 Тогда
        Возврат "";
    КонецЕсли;

    // --- Далее без изменений ---
    Строки = Новый Массив;
    Заголовки = Неопределено;

    ПервыйЭлемент = Данные[0];
    Если ТипЗнч(ПервыйЭлемент) = Тип("Структура") ИЛИ ТипЗнч(ПервыйЭлемент) = Тип("Соответствие") Тогда
        Заголовки = Новый Массив;
        Для Каждого КлючЗначение Из ПервыйЭлемент Цикл
            Заголовки.Добавить(КлючЗначение.Ключ);
        КонецЦикла;

        Если СЗаголовками Тогда
            Строки.Добавить(СтрСоединить(Заголовки, Разделитель));
        КонецЕсли;
    КонецЕсли;

    Для Каждого Элемент Из Данные Цикл
        Если Заголовки <> Неопределено Тогда
            Значения = Новый Массив;
            Для Каждого ИмяПоля Из Заголовки Цикл
                Если ТипЗнч(Элемент) = Тип("Структура") И Элемент.Свойство(ИмяПоля) Тогда
                    Значения.Добавить(ЗначениеВСтрокуCSV(Элемент[ИмяПоля], Разделитель));
                ИначеЕсли ТипЗнч(Элемент) = Тип("Соответствие") Тогда
                    Значения.Добавить(ЗначениеВСтрокуCSV(Элемент[ИмяПоля], Разделитель));
                Иначе
                    Значения.Добавить("");
                КонецЕсли;
            КонецЦикла;
            Строки.Добавить(СтрСоединить(Значения, Разделитель));
        ИначеЕсли ТипЗнч(Элемент) = Тип("Массив") Тогда
            Значения = Новый Массив;
            Для Каждого Знч Из Элемент Цикл
                Значения.Добавить(ЗначениеВСтрокуCSV(Знч, Разделитель));
            КонецЦикла;
            Строки.Добавить(СтрСоединить(Значения, Разделитель));
        КонецЕсли;
    КонецЦикла;

    Возврат СтрСоединить(Строки, Символы.ПС);

КонецФункции
#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция СплющитьСтруктуруCSV(Знач Данные, Знач Префикс)

    Результат = Новый Структура;

    Для Каждого КлючЗначение Из Данные Цикл
        Имя = ?(ПустаяСтрока(Префикс), КлючЗначение.Ключ, 
                Префикс + "_" + КлючЗначение.Ключ);
        ТипЗначения = ТипЗнч(КлючЗначение.Значение);

        Если ТипЗначения = Тип("Структура") ИЛИ ТипЗначения = Тип("Соответствие") Тогда
            Вложенный = СплющитьСтруктуруCSV(КлючЗначение.Значение, Имя);
            Для Каждого КЗ Из Вложенный Цикл
                Результат.Вставить(КЗ.Ключ, КЗ.Значение);
            КонецЦикла;
        ИначеЕсли ТипЗначения = Тип("Массив") Тогда
            Результат.Вставить(Имя, ЗаписатьФорматJSON(КлючЗначение.Значение, Новый Структура));
        Иначе
            Результат.Вставить(Имя, КлючЗначение.Значение);
        КонецЕсли;
    КонецЦикла;

    Возврат Результат;

КонецФункции


Функция ЭкранироватьИмяКлюча(Знач Имя)

    Результат = Имя;
    Результат = СтрЗаменить(Результат, "-", "_");
    Результат = СтрЗаменить(Результат, ":", "_");
    Результат = СтрЗаменить(Результат, ".", "_");
    Результат = СтрЗаменить(Результат, " ", "_");
    Результат = СтрЗаменить(Результат, "/", "_");

    Если СтрДлина(Результат) > 0 Тогда
        ПервыйСимвол = Лев(Результат, 1);
        Если СтрНайти("0123456789", ПервыйСимвол) > 0 Тогда
            Результат = "n" + Результат;
        КонецЕсли;
    КонецЕсли;

    Возврат Результат;

КонецФункции

Функция ЗначениеВСтрокуTOON(Знач Значение, Знач Разделитель = ",")

    Если Значение = Неопределено ИЛИ Значение = Null Тогда
        Возврат "null";
    ИначеЕсли ТипЗнч(Значение) = Тип("Булево") Тогда
        Возврат ?(Значение, "true", "false");
    ИначеЕсли ТипЗнч(Значение) = Тип("Число") Тогда
        Возврат Формат(Значение, "ЧРД=.; ЧГ=");
    ИначеЕсли ТипЗнч(Значение) = Тип("Дата") Тогда
        Если Значение = '00010101' Тогда
            Возврат "null";
        КонецЕсли;
        Возврат Формат(Значение, "ДФ=yyyy-MM-ddTHH:mm:ss");
    ИначеЕсли ТипЗнч(Значение) = Тип("Строка") Тогда
        Если СтрНайти(Значение, Разделитель) > 0 
            ИЛИ СтрНайти(Значение, """") > 0 
            ИЛИ СтрНайти(Значение, Символы.ПС) > 0 
            ИЛИ СтрНайти(Значение, ":") > 0 Тогда
            Возврат """" + СтрЗаменить(Значение, """", """""") + """";
        КонецЕсли;
        Возврат Значение;
    Иначе
        Возврат Строка(Значение);
    КонецЕсли;

КонецФункции

Функция СтрокаВЗначениеTOON(Знач Строка)

    Строка = СокрЛП(Строка);

    Если ПустаяСтрока(Строка) Тогда
        Возврат "";
    КонецЕсли;

    СтрокаНР = НРег(Строка);

    Если СтрокаНР = "null" ИЛИ СтрокаНР = "~" Тогда
        Возврат Null;
    КонецЕсли;
    Если СтрокаНР = "true" ИЛИ СтрокаНР = "yes" Тогда
        Возврат Истина;
    КонецЕсли;
    Если СтрокаНР = "false" ИЛИ СтрокаНР = "no" Тогда
        Возврат Ложь;
    КонецЕсли;

    Если Лев(Строка, 1) = """" И Прав(Строка, 1) = """" Тогда
        Возврат СтрЗаменить(Сред(Строка, 2, СтрДлина(Строка) - 2), """""", """");
    КонецЕсли;

    Если СтрокаЯвляетсяЧислом(Строка) Тогда
        Возврат Число(СтрЗаменить(Строка, " ", ""));
    КонецЕсли;

    Если СтрДлина(Строка) >= 10 И Сред(Строка, 5, 1) = "-" И Сред(Строка, 8, 1) = "-" Тогда
        Попытка
            Если СтрДлина(Строка) = 10 Тогда
                Возврат Дата(СтрЗаменить(Строка, "-", "") + "000000");
            ИначеЕсли СтрДлина(Строка) >= 19 Тогда
                ДатаСтр = Лев(Строка, 10);
                ВремяСтр = Сред(Строка, 12, 8);
                Возврат Дата(СтрЗаменить(ДатаСтр, "-", "") + СтрЗаменить(ВремяСтр, ":", ""));
            КонецЕсли;
        Исключение
        КонецПопытки;
    КонецЕсли;

    Возврат Строка;

КонецФункции

Функция СтрокаЯвляетсяЧислом(Знач Строка)

    Строка = СокрЛП(Строка);
    Если ПустаяСтрока(Строка) Тогда
        Возврат Ложь;
    КонецЕсли;

    ДопустимыеСимволы = "0123456789.-+eE ";

    Для Поз = 1 По СтрДлина(Строка) Цикл
        Если СтрНайти(ДопустимыеСимволы, Сред(Строка, Поз, 1)) = 0 Тогда
            Возврат Ложь;
        КонецЕсли;
    КонецЦикла;

    Попытка
        ПробнаяКонвертация = Число(СтрЗаменить(Строка, " ", ""));
        Возврат Истина;
    Исключение
        Возврат Ложь;
    КонецПопытки;

КонецФункции

Функция ПолучитьОтступ(Знач Уровень)
    Результат = "";
    Для Сч = 1 По Уровень Цикл
        Результат = Результат + "  ";
    КонецЦикла;
    Возврат Результат;
КонецФункции

Функция ПолучитьУровеньОтступа(Знач Строка)
    Уровень = 0;
    Для Поз = 1 По СтрДлина(Строка) Цикл
        Символ = Сред(Строка, Поз, 1);
        Если Символ = " " Тогда
            Уровень = Уровень + 1;
        ИначеЕсли Символ = Символы.Таб Тогда
            Уровень = Уровень + 2;
        Иначе
            Прервать;
        КонецЕсли;
    КонецЦикла;
    Возврат Цел(Уровень / 2);
КонецФункции

Функция МассивОднороден(Знач Массив)

    Если Массив.Количество() < 2 Тогда
        Возврат Истина;
    КонецЕсли;

    ПервыйЭлемент = Массив[0];
    ТипПервого = ТипЗнч(ПервыйЭлемент);

    Если ТипПервого <> Тип("Структура") И ТипПервого <> Тип("Соответствие") Тогда
        Возврат Ложь;
    КонецЕсли;

    КлючиПервого = Новый Массив;
    Для Каждого КлючЗначение Из ПервыйЭлемент Цикл
        КлючиПервого.Добавить(КлючЗначение.Ключ);
        ТипЗначения = ТипЗнч(КлючЗначение.Значение);
        Если ТипЗначения = Тип("Структура") ИЛИ ТипЗначения = Тип("Соответствие") ИЛИ ТипЗначения = Тип("Массив") Тогда
            Возврат Ложь;
        КонецЕсли;
    КонецЦикла;

    Для Инд = 1 По Массив.Количество() - 1 Цикл
        Элемент = Массив[Инд];
        Если ТипЗнч(Элемент) <> ТипПервого Тогда
            Возврат Ложь;
        КонецЕсли;

        КлючиТекущего = Новый Массив;
        Для Каждого КлючЗначение Из Элемент Цикл
            КлючиТекущего.Добавить(КлючЗначение.Ключ);
            ТипЗначения = ТипЗнч(КлючЗначение.Значение);
            Если ТипЗначения = Тип("Структура") ИЛИ ТипЗначения = Тип("Соответствие") ИЛИ ТипЗначения = Тип("Массив") Тогда
                Возврат Ложь;
            КонецЕсли;
        КонецЦикла;

        Если КлючиПервого.Количество() <> КлючиТекущего.Количество() Тогда
            Возврат Ложь;
        КонецЕсли;

        Для Каждого Ключ Из КлючиПервого Цикл
            Если КлючиТекущего.Найти(Ключ) = Неопределено Тогда
                Возврат Ложь;
            КонецЕсли;
        КонецЦикла;
    КонецЦикла;

    Возврат Истина;

КонецФункции

Функция ТаблицаВМассив(Знач Таблица)
    Результат = Новый Массив;
    Для Каждого Строка Из Таблица Цикл
        Объект = Новый Структура;
        Для Каждого Колонка Из Таблица.Колонки Цикл
            Объект.Вставить(Колонка.Имя, Строка[Колонка.Имя]);
        КонецЦикла;
        Результат.Добавить(Объект);
    КонецЦикла;
    Возврат Результат;
КонецФункции

Функция МассивВТаблицу(Знач Массив)
    Таблица = Новый ТаблицаЗначений;

    Если Массив.Количество() = 0 Тогда
        Возврат Таблица;
    КонецЕсли;

    ПервыйЭлемент = Массив[0];
    Если ТипЗнч(ПервыйЭлемент) = Тип("Структура") ИЛИ ТипЗнч(ПервыйЭлемент) = Тип("Соответствие") Тогда
        Для Каждого КлючЗначение Из ПервыйЭлемент Цикл
            Таблица.Колонки.Добавить(КлючЗначение.Ключ);
        КонецЦикла;
    Иначе
        Возврат Таблица;
    КонецЕсли;

    Для Каждого Элемент Из Массив Цикл
        НоваяСтрока = Таблица.Добавить();
        Если ТипЗнч(Элемент) = Тип("Структура") Тогда
            Для Каждого Колонка Из Таблица.Колонки Цикл
                Если Элемент.Свойство(Колонка.Имя) Тогда
                    НоваяСтрока[Колонка.Имя] = Элемент[Колонка.Имя];
                КонецЕсли;
            КонецЦикла;
        ИначеЕсли ТипЗнч(Элемент) = Тип("Соответствие") Тогда
            Для Каждого Колонка Из Таблица.Колонки Цикл
                НоваяСтрока[Колонка.Имя] = Элемент[Колонка.Имя];
            КонецЦикла;
        КонецЕсли;
    КонецЦикла;

    Возврат Таблица;
КонецФункции

Функция ЗначениеВСтрокуCSV(Знач Значение, Знач Разделитель)

    Если Значение = Неопределено ИЛИ Значение = Null Тогда
        Возврат "";
    КонецЕсли;

    Если ТипЗнч(Значение) = Тип("Дата") Тогда
        Если Значение = '00010101' Тогда
            Возврат "";
        КонецЕсли;
        СтрЗначение = Формат(Значение, "ДФ=yyyy-MM-dd HH:mm:ss");
    ИначеЕсли ТипЗнч(Значение) = Тип("Число") Тогда
        СтрЗначение = Формат(Значение, "ЧРД=.; ЧГ=");
    ИначеЕсли ТипЗнч(Значение) = Тип("Булево") Тогда
        СтрЗначение = ?(Значение, "true", "false");
    Иначе
        СтрЗначение = Строка(Значение);
    КонецЕсли;

    Если СтрНайти(СтрЗначение, Разделитель) > 0 ИЛИ СтрНайти(СтрЗначение, """") > 0 ИЛИ СтрНайти(СтрЗначение, Символы.ПС) > 0 Тогда
        Возврат """" + СтрЗаменить(СтрЗначение, """", """""") + """";
    КонецЕсли;

    Возврат СтрЗначение;

КонецФункции

Функция МинЗнач(Знач А, Знач Б)
    Возврат ?(А < Б, А, Б);
КонецФункции

#КонецОбласти
